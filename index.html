<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>カメラ動体検知デモ</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #canvasOutput { position: absolute; top: 0; left: 0; }
    #count { position: absolute; top: 10px; right: 20px; font-size: 24px; color: #00FF00; font-weight: bold; }
  </style>
</head>
<body>
  <video id="video" playsinline autoplay style="display:none;"></video>
  <canvas id="canvasOutput"></canvas>
  <div id="count">0</div>

  <script async src="https://docs.opencv.org/4.5.5/opencv.js" onload="onOpenCvReady();"></script>
  <script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvasOutput');
    let ctx = canvas.getContext('2d');
    let countElem = document.getElementById('count');

    function onOpenCvReady() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => { video.srcObject = stream; video.play(); })
        .catch(err => console.error('カメラへのアクセスに失敗しました: ', err));

      video.addEventListener('playing', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        let cap = new cv.VideoCapture(video);
        let frame = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        let gray = new cv.Mat();
        let prevGray = new cv.Mat();
        let diff = new cv.Mat();
        let thresh = new cv.Mat();
        let M = cv.Mat.ones(5, 5, cv.CV_8U);
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();

        // 初回フレームをキャプチャ
        cap.read(frame);
        cv.cvtColor(frame, prevGray, cv.COLOR_RGBA2GRAY);

        function process() {
          cap.read(frame);
          cv.cvtColor(frame, gray, cv.COLOR_RGBA2GRAY);
          // フレーム差分を計算
          cv.absdiff(gray, prevGray, diff);
          cv.threshold(diff, thresh, 25, 255, cv.THRESH_BINARY);
          // ノイズ除去
          cv.morphologyEx(thresh, thresh, cv.MORPH_OPEN, M);
          // 輪郭検出
          cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

          // 描画
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          let count = 0;
          for (let i = 0; i < contours.size(); ++i) {
            let cnt = contours.get(i);
            let rect = cv.boundingRect(cnt);
            // 小さなノイズを除外
            if (rect.width * rect.height < 500) continue;
            count++;
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 2;
            ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
          }
          countElem.textContent = count;

          // 今のフレームを次の比較用に保存
          gray.copyTo(prevGray);
          requestAnimationFrame(process);
        }
        requestAnimationFrame(process);
      });
    }
  </script>
</body>
</html>
